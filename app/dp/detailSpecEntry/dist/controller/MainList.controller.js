sap.ui.define(["ext/lib/controller/BaseController","sap/ui/core/routing/History","sap/ui/model/json/JSONModel","ext/lib/model/ManagedListModel","ext/lib/formatter/DateFormatter","sap/m/TablePersoController","./MainListPersoService","sap/ui/model/Filter","sap/ui/model/FilterOperator","sap/ui/model/Sorter","sap/m/MessageBox","sap/m/MessageToast","sap/m/ColumnListItem","sap/m/ObjectIdentifier","sap/m/Text","sap/m/Input","sap/m/ComboBox","sap/ui/core/Item","sap/m/Label","sap/m/Token","sap/m/SearchField","ext/lib/util/Validator"],function(e,t,a,i,s,o,n,l,r,d,h,u,g,c,p,m,w,f,y,_,b,v){"use strict";return e.extend("dp.detailSpecEntry.controller.MainList",{dateFormatter:s,validator:new v,onInit:function(){var e,t=this.getResourceBundle();e=new a({headerExpanded:true,mainListTableTitle:t.getText("mainListTableTitle"),tableNoDataText:t.getText("tableNoDataText")});this.setModel(e,"mainListView");this.addHistoryEntry({title:t.getText("mainListViewTitle"),icon:"sap-icon://table-view",intent:"#Template-display"},true);this._doInitSearch();this.setModel(new i,"list");this.setModel(new i,"orgMap");this.setModel(new i,"division");this.getRouter().getRoute("mainPage").attachPatternMatched(this._onRoutedThisPage,this);this._doInitTablePerso()},onAfterRendering:function(){this.byId("pageSearchButton").firePress();return},_doInitSearch:function(){var e=this.byId("page").getHeaderExpanded()?"E":"S";this.getView().setModel(this.getOwnerComponent().getModel());this.setDivision("LGEKR");this.getView().byId("searchCompanyS").setSelectedKeys(["LGEKR"]);this.getView().byId("searchCompanyE").setSelectedKeys(["LGEKR"]);this.getView().byId("searchDivisionS").setSelectedKeys(["DFZ"]);this.getView().byId("searchDivisionE").setSelectedKeys(["DFZ"]);var t=new Date;this.getView().byId("searchDateS").setDateValue(new Date(t.getFullYear(),t.getMonth(),t.getDate()-90));this.getView().byId("searchDateS").setSecondDateValue(new Date(t.getFullYear(),t.getMonth(),t.getDate()));this.getView().byId("searchDateE").setDateValue(new Date(t.getFullYear(),t.getMonth(),t.getDate()-90));this.getView().byId("searchDateE").setSecondDateValue(new Date(t.getFullYear(),t.getMonth(),t.getDate()))},setDivision:function(e){var t=new l({filters:[new l("tenant_id",r.EQ,"L1100"),new l("company_code",r.EQ,e)],and:true});var a={path:"/Divisions",filters:t,template:new f({key:"{org_code}",text:"[{org_code}] {org_name}"})};this.getView().byId("searchDivisionS").bindItems(a);this.getView().byId("searchDivisionE").bindItems(a)},onMainTableUpdateFinished:function(e){var t,a=e.getSource(),i=e.getParameter("total");if(i&&a.getBinding("items").isLengthFinal()){t=this.getResourceBundle().getText("mainListTableTitleCount",[i])}else{t=this.getResourceBundle().getText("mainListTableTitle")}this.getModel("mainListView").setProperty("/mainListTableTitle",t)},onMainTablePersoButtonPressed:function(e){this._oTPC.openDialog()},onMainTablePersoRefresh:function(){n.resetPersData();this._oTPC.refresh()},onMainTableAddButtonPress:function(){var e=this.getOwnerComponent().getHelper().getNextUIState(1);this.getRouter().navTo("midPage",{layout:e.layout,tenantId:"new",moldId:"code"})},onPageSearchButtonPress:function(e){if(e.getParameters().refreshButtonPressed){this.onRefresh()}else{this.validator.validate(this.byId("pageSearchFormE"));if(this.validator.validate(this.byId("pageSearchFormS"))!==true)return;var t=this._getSearchStates();this._applySearch(t)}},onMainTableItemPress:function(e){var t=this.getOwnerComponent().getHelper().getNextUIState(1),a=e.getSource().getBindingContext("list").getPath(),i=this.getModel("list").getProperty(a);this.getRouter().navTo("midPage",{layout:t.layout,tenantId:i.tenant_id,moldId:i.mold_id});if(t.layout==="TwoColumnsMidExpanded"){this.getView().getModel("mainListView").setProperty("/headerExpandFlag",false)}var s=e.getSource();s.setNavigated(true);var o=s.getParent();this.iIndex=o.indexOfItem(s)},_onRoutedThisPage:function(){this.getModel("mainListView").setProperty("/headerExpanded",true);var e=this;var t=this.getModel("orgMap");t.setTransactionModel(this.getModel("purOrg"))},_applySearch:function(e){var t=this.getView(),a=this.getModel("list");t.setBusy(true);a.setTransactionModel(this.getModel());a.read("/MoldMasterSpec",{filters:e,success:function(e){t.setBusy(false)}})},_getSearchStates:function(){var e=this.byId("page").getHeaderExpanded()?"E":"S";var t=this.getView().byId("searchCompany"+e).getSelectedKeys();var a=this.getView().byId("searchDivision"+e).getSelectedKeys();var i=this.getView().byId("searchDate"+e).getDateValue();var s=this.getView().byId("searchDate"+e).getSecondDateValue();var o=this.getView().byId("searchModel").getValue().trim();var n=this.getView().byId("searchPart").getValue().trim();var d=this.getView().byId("searchFamilyPart").getValue().trim();var h=this.getView().byId("searchStatus").getSelectedKey();var u=[];if(t.length>0){var g=[];t.forEach(function(e,t,a){g.push(new l("company_code",r.EQ,e))});u.push(new l({filters:g,and:false}))}if(a.length>0){var g=[];a.forEach(function(e,t,a){g.push(new l("org_code",r.EQ,e))});u.push(new l({filters:g,and:false}))}if(i||i){var g=[];g.push(new l({path:"mold_spec_register_date",operator:r.BT,value1:this.getFormatDate(i),value2:this.getFormatDate(s)}));g.push(new l("mold_spec_register_date",r.EQ,""));g.push(new l("mold_spec_register_date",r.EQ,null));u.push(new l({filters:g,and:false}))}if(o){u.push(new l("tolower(model)",r.Contains,"'"+o.toLowerCase().replace("'","''")+"'"))}if(n){u.push(new l("tolower(mold_number)",r.Contains,"'"+n.toLowerCase()+"'"))}if(d){u.push(new l("tolower(family_part_numbers)",r.Contains,"'"+d.toLowerCase()+"'"))}if(h){u.push(new l("mold_spec_status_code",r.EQ,h))}return u},_doInitTablePerso:function(){this._oTPC=new o({table:this.byId("mainTable"),componentName:"detailSpecEntry",persoService:n,hasGrouping:true}).activate()},handleSelectionFinishComp:function(e){this.copyMultiSelected(e);var t=e.getParameters();var a=[];if(t.selectedItems.length>0){t.selectedItems.forEach(function(e,t,i){a.push(new l({filters:[new l("tenant_id",r.EQ,"L1100"),new l("company_code",r.EQ,e.getKey())],and:true}))})}else{a.push(new l("tenant_id",r.EQ,"L1100"))}var i=new l({filters:a,and:false});this.getView().byId("searchDivisionS").getBinding("items").filter(i,"Application");this.getView().byId("searchDivisionE").getBinding("items").filter(i,"Application")},handleSelectionFinishDiv:function(e){this.copyMultiSelected(e)},copyMultiSelected:function(e){var t=e.getSource();var a=e.getParameters();var i=t.sId.split("--")[1];var s=i.substr(0,i.length-1);var o=[];a.selectedItems.forEach(function(e,t,a){o.push(e.getKey())});this.getView().byId(s+"S").setSelectedKeys(o);this.getView().byId(s+"E").setSelectedKeys(o)},onValueHelpRequested:function(e){var t="";this._oValueHelpDialog=sap.ui.xmlfragment("dp.detailSpecEntry.view.ValueHelpDialogModel",this);this._oBasicSearchField=new b({showSearchButton:false});var i=this._oValueHelpDialog.getFilterBar();i.setFilterBarExpanded(false);i.setBasicSearch(this._oBasicSearchField);if(e.getSource().sId.indexOf("searchModel")>-1){this._oInputModel=this.getView().byId("searchModel");this.oColModel=new a({cols:[{label:"Model",template:"model"}]});t="/Models";this._oValueHelpDialog.setTitle("Model");this._oValueHelpDialog.setKey("model");this._oValueHelpDialog.setDescriptionKey("model")}else if(e.getSource().sId.indexOf("searchPart")>-1){this._oInputModel=this.getView().byId("searchPart");this.oColModel=new a({cols:[{label:"Part No",template:"mold_number"},{label:"Item Type",template:"mold_item_type_name"},{label:"Description",template:"spec_name"}]});t="/PartNumbers";this._oValueHelpDialog.setTitle("Part No");this._oValueHelpDialog.setKey("mold_number");this._oValueHelpDialog.setDescriptionKey("spec_name")}var s=this.oColModel.getData().cols;this.getView().addDependent(this._oValueHelpDialog);this._oValueHelpDialog.getTableAsync().then(function(e){e.setModel(this.getOwnerComponent().getModel());e.setModel(this.oColModel,"columns");if(e.bindRows){e.bindAggregation("rows",t)}if(e.bindItems){e.bindAggregation("items",t,function(){return new g({cells:s.map(function(e){return new y({text:"{"+e.template+"}"})})})})}this._oValueHelpDialog.update()}.bind(this));var o=new _;o.setKey(this._oInputModel.getSelectedKey());o.setText(this._oInputModel.getValue());this._oValueHelpDialog.setTokens([o]);this._oValueHelpDialog.open()},onValueHelpOkPress:function(e){var t=e.getParameter("tokens");this._oInputModel.setSelectedKey(t[0].getKey());this._oValueHelpDialog.close()},onValueHelpCancelPress:function(){this._oValueHelpDialog.close()},onValueHelpAfterClose:function(){this._oValueHelpDialog.destroy()},onFilterBarSearch:function(e){var t=this._oBasicSearchField.getValue(),a=e.getParameter("selectionSet");var i=a.reduce(function(e,t){if(t.getValue()){e.push(new l({path:t.getName(),operator:r.Contains,value1:t.getValue()}))}return e},[]);var s=[];if(this._oValueHelpDialog.oRows.sPath.indexOf("/Models")>-1){s.push(new l("tolower(model)",r.Contains,"'"+t.toLowerCase().replace("'","''")+"'"))}else if(this._oValueHelpDialog.oRows.sPath.indexOf("/PartNumbers")>-1){s.push(new l({path:"tolower(mold_number)",operator:r.Contains,value1:"'"+t.toLowerCase()+"'"}));s.push(new l({path:"tolower(mold_item_type_name)",operator:r.Contains,value1:"'"+t.toLowerCase()+"'"}));s.push(new l({path:"tolower(spec_name)",operator:r.Contains,value1:"'"+t.toLowerCase()+"'"}))}i.push(new l({filters:s,and:false}));this._filterTable(new l({filters:i,and:true}))},_filterTable:function(e){var t=this._oValueHelpDialog;t.getTableAsync().then(function(a){if(a.bindRows){a.getBinding("rows").filter(e)}if(a.bindItems){a.getBinding("items").filter(e)}t.update()})},getFormatDate:function(e){var t=e.getFullYear();var a=1+e.getMonth();a=a>=10?a:"0"+a;var i=e.getDate();i=i>=10?i:"0"+i;return t+""+a+""+i}})});
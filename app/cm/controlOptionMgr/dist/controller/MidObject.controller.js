sap.ui.define(["ext/lib/controller/BaseController","ext/lib/util/ValidatorUtil","sap/ui/model/json/JSONModel","ext/lib/model/TransactionManager","ext/lib/model/ManagedModel","ext/lib/model/ManagedListModel","ext/lib/formatter/DateFormatter","sap/ui/model/Filter","sap/ui/model/FilterOperator","sap/ui/core/Fragment","sap/m/MessageBox","sap/m/MessageToast","sap/m/ColumnListItem","sap/m/ObjectIdentifier","sap/m/Text","sap/m/Input","sap/m/ComboBox","sap/ui/core/Item"],function(t,e,o,n,i,a,s,l,d,r,c,u,g,_,h,p,m,f){"use strict";var M;return t.extend("cm.controlOptionMgr.controller.MidObject",{dateFormatter:s,formatter:function(){return{toYesNo:function(t){return t===true?"YES":"NO"}}}(),selectionChange:function(t){var e=t.getSource().getParent().getCells()[3].getItems()[0];e.clearSelection();e.bindItems({path:"org>/organization",filters:[new l("type",d.EQ,t.getSource().getSelectedKey())],template:new f({key:"{org>code}",text:"{org>code}"})})},onInit:function(){var t=new o({busy:true,delay:0,screen:"",editMode:""});this.getRouter().getRoute("midPage").attachPatternMatched(this._onRoutedThisPage,this);this.setModel(t,"midObjectView");this.setModel(new i,"master");this.setModel(new a,"details");M=new n;M.addDataModel(this.getModel("master"));M.addDataModel(this.getModel("details"));this.getModel("master").attachPropertyChange(this._onMasterDataChanged.bind(this));this._initTableTemplates();this.enableMessagePopover()},onPageEnterFullScreenButtonPress:function(){var t=this.getModel("fcl").getProperty("/actionButtonsInfo/midColumn/fullScreen");this.getRouter().navTo("midPage",{layout:t,tenantId:this._sTenantId,controlOptionCode:this._sControlOptionCode})},onPageExitFullScreenButtonPress:function(){var t=this.getModel("fcl").getProperty("/actionButtonsInfo/midColumn/exitFullScreen");this.getRouter().navTo("midPage",{layout:t,tenantId:this._sTenantId,controlOptionCode:this._sControlOptionCode})},onPageNavBackButtonPress:function(){var t=this.getModel("fcl").getProperty("/actionButtonsInfo/midColumn/closeColumn");this.getRouter().navTo("mainPage",{layout:t})},onPageEditButtonPress:function(){this._toEditMode()},onPageDeleteButtonPress:function(){var t=this.getView(),e=this.getModel("master"),o=this;c.confirm("Are you sure to delete this control option and details?",{title:"Comfirmation",initialFocus:sap.m.MessageBox.Action.CANCEL,onClose:function(n){if(n===c.Action.OK){t.setBusy(true);e.removeData();e.setTransactionModel(o.getModel());e.submitChanges({success:function(e){t.setBusy(false);o.onPageNavBackButtonPress.call(o);u.show("Success to delete.")}})}}})},onMidTableAddButtonPress:function(){var t=this.byId("midTable"),e=this.getModel("details");var o=function(t){return function(e){return t(e)}};var n=o(function(t){var e=t.getFullYear()+"";var o=t.getMonth()+1+"";var n=t.getDate()+"";var i=t.getHours()+"";var a=t.getHours()+"";var s=t.getSeconds()+"";return new Date([e,o.length==1?"0"+o:o,n.length==1?"0"+n:n].join("-")+function(){if(!i&&!a&&!s){return""}return"T"+[i.length==1?"0"+i:i,a.length==1?"0"+a:a,s.length==1?"0"+s:s].join(":")}())});e.addRecord({tenant_id:this._sTenantId||"",control_option_code:this._sControlOptionCode||"",org_type_code:"*",start_date:n(new Date),end_date:n(new Date),local_create_dtm:n(new Date),local_update_dtm:n(new Date)},0)},onMidTableDeleteButtonPress:function(){var[t,e,o]=arguments;var n=this.byId(t);var i=this.getView().getModel(e);n.getSelectedItems().map(t=>i.getData()[o].indexOf(t.getBindingContext("details").getObject())).reverse().forEach(function(t){i.markRemoved(t)});n.removeSelections(true)},onPageSaveButtonPress:function(){var t=this.getView(),e=t.getModel("master"),o=t.getModel("details"),n=this;console.log(">>> detail",o.getData());if(!e.getData()["chain_code"]){c.alert("Chain을 입력하세요");return}if(!e.getData()["tenant_id"]){c.alert("테넌트를 입력하세요");return}if(!e.getData()["control_option_code"]){c.alert("제어옵션코드를 입력하세요");return}if(!e.getData()["control_option_name"]){c.alert("제어옵션명을 입력하세요");return}if(e.getData()["_state_"]!="C"&&o.getChanges()<=0){c.alert("변경사항이 없습니다.");return}if(e.getData()["_state_"]=="C"){o.getData()["ControlOptionDetails"].map(t=>{t["tenant_id"]=e.getData()["tenant_id"];t["control_option_code"]=e.getData()["control_option_code"];return t})}c.confirm("Are you sure ?",{title:"Comfirmation",initialFocus:sap.m.MessageBox.Action.CANCEL,onClose:function(e){if(e===c.Action.OK){t.setBusy(true);M.submit({success:function(e){n._toShowMode();t.setBusy(false);n.getOwnerComponent().getRootControl().byId("fcl").getBeginColumnPages()[0].byId("pageSearchButton").firePress();u.show("Success to save.")}})}}})},onPageCancelEditButtonPress:function(){if(this.getModel("midObjectView").getProperty("/isAddedMode")==true){this.onPageNavBackButtonPress.call(this)}else{this._toShowMode();this.getModel("details").setTransactionModel(this.getModel()).read("/ControlOptionDetails",{filters:[new l("tenant_id",d.EQ,this._sTenantId||"XXXXX"),new l("control_option_code",d.EQ,this._sControlOptionCode)],success:function(t){}})}},_onMasterDataChanged:function(t){if(this.getModel("midObjectView").getProperty("/isAddedMode")==true){var e=this.getModel("master");var o=this.getModel("details");var n=e.getProperty("/tenant_id");var i=e.getProperty("/control_option_code");var a=o.getData();a.forEach(function(t,e){o.setProperty("/"+e+"/tenant_id",n);o.setProperty("/"+e+"/control_option_code",i)});o.setData(a)}},_onRoutedThisPage:function(t){var e=t.getParameter("arguments"),o=this.getView();this._sTenantId=e.tenantId;this._sControlOptionCode=e.controlOptionCode;if(e.tenantId=="new"&&e.controlOptionCode=="code"){this.getModel("midObjectView").setProperty("/isAddedMode",true);var n=this.getModel("master");n.setData({tenant_id:"L2100",chain_code:"",control_option_code:"",control_option_name:"",group_code:"",local_create_dtm:new Date,local_update_dtm:new Date},"/ControlOptionMasters",0);var i=this.getModel("details");i.setTransactionModel(this.getModel());i.read("/ControlOptionDetails",{filters:[new l("tenant_id",d.EQ,this._sTenantId||"XXXXX")],success:function(t){}});this._toEditMode()}else{this.getModel("midObjectView").setProperty("/isAddedMode",false);this._bindView("/ControlOptionMasters(tenant_id='"+this._sTenantId+"',control_option_code='"+this._sControlOptionCode+"')");o.setBusy(true);var i=this.getModel("details");i.setTransactionModel(this.getModel());i.read("/ControlOptionDetails",{filters:[new l("tenant_id",d.EQ,this._sTenantId),new l("control_option_code",d.EQ,this._sControlOptionCode)],success:function(t){o.setBusy(false)}});this._toShowMode()}M.setServiceModel(this.getModel())},_bindView:function(t){var e=this.getView(),o=this.getModel("master");e.setBusy(true);o.setTransactionModel(this.getModel());o.read(t,{success:function(t){e.setBusy(false)}})},_toEditMode:function(){var t=false;this._showFormFragment("MidObject_Edit");this.byId("page").setSelectedSection("pageSectionMain");this.byId("page").setProperty("showFooter",!t);this.byId("pageEditButton").setEnabled(t);this.byId("pageDeleteButton").setEnabled(t);this.byId("pageNavBackButton").setEnabled(t);this.byId("midTableAddButton").setEnabled(!t);this.byId("midTableDeleteButton").setEnabled(!t)},_toShowMode:function(){var t=true;this._showFormFragment("MidObject_Show");this.byId("page").setSelectedSection("pageSectionMain");this.byId("page").setProperty("showFooter",!t);this.byId("pageEditButton").setEnabled(t);this.byId("pageDeleteButton").setEnabled(t);this.byId("pageNavBackButton").setEnabled(t);this.byId("midTableAddButton").setEnabled(!t);this.byId("midTableDeleteButton").setEnabled(!t)},_initTableTemplates:function(){this.oReadOnlyTemplate=new g({cells:[new h({text:"{details>_row_state_}"}),new _({text:"{details>control_option_code}"}),new _({text:"{details>control_option_level_code}"}),new h({text:"{details>control_option_level_val}"}),new h({text:"{details>control_option_val}"})],type:sap.m.ListType.Inactive});this.oEditableTemplate=new g({cells:[new h({text:"{details>_row_state_}"}),new m({selectedKey:"{details>control_option_level_code}",items:{path:"util>/CodeDetails",filters:[new l("tenant_id",d.EQ,"L2100"),new l("group_code",d.EQ,"CM_CTRL_OPTION_LEVEL_CODE")],template:new f({key:"{util>code}",text:"{= ${util>code} + ':' + ${util>code_description}}"})},editable:"{= ${details>_row_state_} === 'C' }",required:true}),function(t){if(t=="T"){return new m({selectedKey:"{details>org_type_code}",items:{path:"util>/CodeDetails",filters:[new l("tenant_id",d.EQ,"L2100"),new l("group_code",d.EQ,"CM_ORG_TYPE_CODE")],template:new f({key:"{util>code}",text:"{= ${util>code} + ':' + ${util>code_description}}"})},editable:"{= ${details>_row_state_} === 'C' }",display:"none",required:true})}else{new p({value:{path:"details>control_option_level_val",type:new sap.ui.model.type.String(null,{maxLength:100})},editable:"{= ${details>_row_state_} === 'C' }",required:true})}}("{= ${details>control_option_level_code}}"),new p({value:{path:"details>control_option_level_val",type:new sap.ui.model.type.String(null,{maxLength:100})},editable:"{= ${details>_row_state_} === 'C' }",required:true}),new p({value:{path:"details>control_option_val",type:new sap.ui.model.type.String(null,{maxLength:100})},required:true})]})},_bindMidTable:function(t,e){this.byId("midTable").bindItems({path:"details>/ControlOptionDetails",template:t}).setKeyboardMode(e)},_oFragments:{},_showFormFragment:function(t){var e=this.byId("pageSubSection1");this._loadFragment(t,function(t){e.removeAllBlocks();e.addBlock(t)})},_loadFragment:function(t,e){if(!this._oFragments[t]){r.load({id:this.getView().getId(),name:"cm.controlOptionMgr.view."+t,controller:this}).then(function(o){this._oFragments[t]=o;if(e)e(o)}.bind(this))}else{if(e)e(this._oFragments[t])}}})});
sap.ui.define(["sap/base/Log","sap/m/MessageBox","sap/m/MessageToast","sap/ui/core/format/DateFormat","cm/controlOptionMgr/controller/BaseController","sap/ui/model/Filter","sap/ui/model/FilterOperator","sap/ui/model/FilterType","sap/ui/model/Sorter","sap/ui/model/json/JSONModel","sap/ui/table/RowSettings","sap/ui/thirdparty/jquery","sap/m/Token","sap/m/MessageStrip","sap/ui/core/InvisibleMessage","sap/ui/core/library"],function(e,t,o,n,s,i,r,a,l,c,g,u,d,h,p,f){"use strict";var _=f.InvisibleMessageMode;return s.extend("cm.controlOptionMgr.controller.Main",{onInit:function(){console.group("onInit");this._setMessage();this._createView();this._bTechnicalErrors=false;this._searchControlInit();console.groupEnd()},_setMessage:function(){console.group("_setMessage");this.errorHasUIChangesSave="상세 테이블에서 저장하지 않은 변경 내용이 있습니다. [취소] 또는 상세 [저장] 이후 항목 을 선택할수 있습니다.";this.errorIsHasUIChangesCancelSave="저장되지 않은 수정 작업이 모두 취소 됩니다.";this.confirmCancelSave="저장되지 않은 수정 작업이 모두 취소 됩니다.";this.confirmCancelTitle="취소 확인";this.sucessCancel="취소가 성공 하였습니다.";this.errorSubHasUIChangeCreateRow="상세 테이블에서 저장하지 않은 변경 내용이 있습니다. 변경 내용을 저장후 행추가 가능합니다.";this.errorUIChangeCopyRow="상세 테이블에서 저장하지 않은 변경 내용이 있습니다. 변경 내용을 저장후 행복사 가능합니다.";this.errorCheckChangeCopyRow="행복사는 선택 항목이 하나여야 합니다.";this.errorCheckChangeCopyRowTitle="항목 선택 오류";this.errorDeleteRowChooice="삭제할 항목을 선택해야 합니다.";this.confirmAllDeleteRow="선택된 항목을 삭제 하시 겠습니까? 하위 등록된 데이타도 같이 삭제 됩니다.";this.confirmDeleteRow="선택된 항목을 삭제 하시 겠습니까?";this.confirmDeleteRowTitle="삭제 확인";this.sucessDelete="삭제가 성공 하였습니다.";this.sucessSave="저장이 성공 하였습니다.";this.noChangeContent="수정한 내용이 없습니다.";this.confirmSave="저장 하시 겠습니까?";this.confirmSaveTitle="저장 확인";console.groupEnd()},_setButtonState:function(){return;var e=this.getModel("ui"),t=this.getView().byId("mainList");if(e.getProperty("/bSubCheck")){t=this.getView().byId("subList")}var o=t.getSelectedIndices();console.log("table rowindices",o);var n=e.getProperty("/bSubListTrue"),s=e.getProperty("/bSearch");if(s==true){e.setProperty("/bAdd",true);e.setProperty("/bSave",true)}if(e.getProperty("/bCheck")){if(o.length>0){e.setProperty("/bAdd",true);e.setProperty("/bCopy",true);e.setProperty("/bDelete",true);if(o.length>1){e.setProperty("/bCopy",false)}}else{e.setProperty("/bCopy",false);e.setProperty("/bDelete",false)}}else{if(!e.getProperty("/bSubListTrue")){e.setProperty("/bSubCheck",false)}else{o=this.getView().byId("subList").getSelectedIndices().length;console.log("sublist indices length",o);if(o>0){e.setProperty("/bSubCheck",true)}else{e.setProperty("/bSubCheck",false)}}}console.groupEnd()},onDataEvents:function(e){console.group("onDataEvents");var t=this.getModel("ui"),o=this.getView().byId("subList");var n=[],s=e.getSource();if(e.getId()==="dataReceived"){console.log("dataReceived event");var i=s.iMaxLength;console.log("subListlength",i);if(i>0){t.setProperty("/bSubListTrue",true)}else{t.setProperty("/bSubListTrue",false)}}console.groupEnd()},_createView:function(){console.group("_createView");this.oInvisibleMessage=p.getInstance();var e=this.getView();var t=new c({filterCommonID:"",filterValue:"",hasUIChanges:false,hasMainUIChanges:false,hasSubUiChanges:false,bSearch:false,bAdd:true,bDelete:true,bCopy:true,bSelect:true,bCheck:true,subListCount:0,bSubCheck:false,bSubListTrue:false});var o=new c({data:[],selectrow:[],control_option_codeEmpty:true,control_option_nameEmpty:true});var n=new c({data:[],selectrow:[],control_option_level_codeEdit:true,control_option_valEdit:true});this.setModel(t,"ui");this.setModel(o,"mainModel");this.setModel(n,"subModel");console.groupEnd()},onSearch:function(){console.group("onSearch");var e=this.getModel("ui"),t=this.byId("mainList").getBinding("rows"),o=this.byId("mainList").getBinding("rows");e.setProperty("/bSearch",true);var n=new i("tenant_id",r.EQ,"1000"),s=new i("company_code",r.EQ,"G100"),a=new i("tenant_id",r.EQ,"0000");this.getView().setBusy(true);t.resetChanges();o.resetChanges();t.filter([n,s]);this._setButtonState();this.getView().setBusy(false);console.groupEnd()},onCellClick:function(e){console.group("onCellClick");var t=this.getView().getModel("mainModel"),o=this.getView().getModel("ui"),n=this.getView(),s=this.byId("subList"),i=e.getParameter("rowContext");var r=s.getBinding("rows");if(r.hasPendingChanges()){this._showMsgStrip("e",this.errorHasUIChangesSave);return}var a=e.getParameter("rowIndex"),l=this.byId("mainList");console.log("Indices: "+l.getSelectedIndices());var g=this.byId("mainList").getBinding("rows"),u=l.getRows();console.log("rowIndex",a);t.setProperty("/data","");t.setProperty("/selectrow","");o.setProperty("/bSelect",a>-1?true:false);var d=new c({tenant_id:"",company_code:"",chain_code:"",control_option_code:""});d.tenant_id=u[a].getCells()[0].mProperties.value;d.company_code=u[a].getCells()[1].mProperties.value;d.chain_code=u[a].getCells()[2].mProperties.value;d.control_option_code=u[a].getCells()[3].mProperties.value;t.setProperty("/selectrow",d);t.setProperty("/data",d);console.group("selectRow");console.dir(t.getProperty("/selectrow"));console.groupEnd();this._onSubListBinding(a);this._setButtonState();console.groupEnd()},onCheck:function(e){console.group("onCheck");var t=e,o=this.getModel("ui"),n=false,s,i=this;if(t!="mainList"){n=true}else{o.setProperty("/bCheck",true)}console.log("tableName: "+t);s=this.byId(t);if(n){console.log("subList row change event");o.setProperty("/bSubCheck",n)}else{console.log("mainList row change event")}this._setButtonState();console.groupEnd()},_getToday:function(){var e=new Date;var t=("0"+e.getDate()).slice(-2);var o=("0"+(e.getMonth()+1)).slice(-2);var n=e.getFullYear();console.log(n+"-"+o+"-"+t);return n+"-"+o+"-"+t},_getUtcSapDate:function(){var e=sap.ui.core.format.DateFormat.getDateInstance({pattern:"yyyy-MM-dd'T'HH:mm"});var t=new Date;var o=e.format(t)+":00Z";console.log("utcDate",o);return o},onCancelChanges:function(e){console.group("onCancelChanges");var o=e,n=false,s=this;console.log("tableName: "+o);if(o!="mainList"){n=true}t.confirm(this.errorIsHasUIChangesCancelSave,{title:this.confirmCancelTitle,initialFocus:sap.m.MessageBox.Action.CANCEL,onClose:function(e){if(e===t.Action.OK){if(!n){s.getView().getModel().resetChanges("MainUpdateGroup")}else{s.getView().getModel().resetChanges("SubUpdateGroup")}s._setUIChanges(null,false);s._showMsgStrip("s",s.sucessCancel)}else if(e===t.Action.CANCEL){return}}});console.groupEnd()},onCreateRow:function(e){console.group("onCreate");var t=e,o=false,n,s=this;console.log("tableName: "+t);if(t!="mainList"){o=true}var i=this.getModel("ui"),r=this.byId(t);var a=r.getBinding("rows"),l=this._getToday(),c=this._getUtcSapDate();if(!o){if(a.hasPendingChanges()){this._showMsgStrip("e",this.errorSubHasUIChangeCreateRow);return}n=a.create({tenant_id:"1000",company_code:"G100",control_option_code:"",chain_code:"CM",control_option_name:"",start_date:this._getToday(),end_date:"9999-12-31",site_yn:false,company_yn:false,role_yn:false,organization_yn:false,user_yn:false,local_create_dtm:c,local_update_dtm:c,update_user_id:"Admin"})}else{this._setUIChanges(null,false);var g=this.getModel("mainModel"),u=this.getView(),d=this.byId("subList");n=a.create({tenant_id:g.getProperty("/selectrow/tenant_id"),company_code:g.getProperty("/selectrow/company_code"),control_option_code:g.getProperty("/selectrow/control_option_code"),control_option_level_code:"",control_option_level_val:"",control_option_val:"",local_create_dtm:c,local_update_dtm:c,update_user_id:"Admin"})}this.getView().setBusy(true);n.created().then(function(){a.refresh()});r.getRows().some(function(e){if(e.getBindingContext()===n){e.focus();e.setSelected(true);return true}});if(!o){s._subListFilter()}this.getView().setBusy(false);console.groupEnd()},onCopyRow:function(e){console.group("onCopyRow");var o=this.byId("mainList"),n=o.getBinding("rows"),s=o.getRows(),i=o.getSelectedIndices(),r=this._getToday(),a=this._getUtcSapDate();console.log("indices",i);if(this.byId("subList").getBinding("rows").hasPendingChanges()){this._showMsgStrip("e",this.errorUIChangeCopyRow);return}if(i.length>1){t.show(this.errorCheckChangeCopyRow,{icon:t.Icon.ERROR,title:this.errorCheckChangeCopyRowTitle,actions:[t.Action.OK],styleClass:"sapUiSizeCompact"});return}var l=this.getModel("mainModel");var c=n.create({tenant_id:l.tenant_id,company_code:l.company_code,control_option_code:l.control_option_code,chain_code:l.chain_code,control_option_name:l.control_option_name,start_date:l.start_date,end_date:l.end_date,site_yn:false,company_yn:false,role_yn:false,organization_yn:false,user_yn:false,local_create_dtm:a,local_update_dtm:a});o.clearSelection();this.getView().setBusy(true);c.created().then(function(){n.refresh()});o.getRows().some(function(e){if(e.getBindingContext()===c){e.focus();e.setSelected(true);return true}});this.getView().setBusy(false);console.groupEnd()},onDelete:function(e){console.group("onDelete");var o=e,n,s=false,i=this;if(o!="mainList"){s=true}n=this.byId(e);var r=n.getSelectedIndices();if(r.length<1){t.show(this.errorDeleteRowChooice,{icon:t.Icon.ERROR,title:this.errorCheckChangeCopyRowTitle,actions:[t.Action.OK],styleClass:"sapUiSizeCompact"})}else{var a=this.confirmAllDeleteRow;if(!s){a=this.confirmDeleteRow}t.confirm(a,{title:this.confirmDeleteRowTitle,initialFocus:sap.m.MessageBox.Action.CANCEL,onClose:function(e){if(e===t.Action.OK){for(var o=0;o<r.length;o++){var a=r[o];if(n.isIndexSelected(a)){i.getView().setBusy(true);n.getContextByIndex(a).delete("$auto").then(function(){if(!s){i._subListFilter()}i._showMsgStrip("s",i.sucessDelete);n.clearSelection()}.bind(this),function(e){t.error(e.message)});i.getView().setBusy(false)}}}else if(e===t.Action.CANCEL){return}}})}console.groupEnd()},_onSubListBinding:function(e){console.group("_onSubListBinding");var t=this.getModel("mainModel"),o=this.getView(),n=this.byId("subList");var s=t.getProperty("/selectrow");console.log("oSelectRow.tenant_id",s.tenant_id);console.log("oSelectRow.company_code",s.company_code);console.log("oSelectRow.control_option_code",s.control_option_code);var a=new i("tenant_id",r.EQ,s.tenant_id),l=new i("company_code",r.EQ,s.company_code),c=new i("control_option_code",r.EQ,s.control_option_code);var g=n.getBinding("rows");g.filter([a,l,c]);console.groupEnd()},onInputChange:function(e){console.group("onInputChange");var t=this.getView().getModel("mainModel"),o=true,n;if(e!=null){if(e.getSource().sId.indexOf("control_option_level_code")>-1){t=this.getView().getModel("subModel");o=false}else if(e.getSource().sId.indexOf("control_option_level_val")>-1){t=this.getView().getModel("subModel");o=false}}else{e=null}if(e.getParameter("escPressed")){this._setUIChanges(e,false)}else{this._setUIChanges(e,true);if(o){if(e.getSource().getParent().getBindingContext().getProperty("control_option_code")){t.setProperty("/control_option_codeEmpty",false)}if(e.getSource().getParent().getBindingContext().getProperty("control_option_name")){t.setProperty("/control_option_nameEmpty",false)}}else{if(e.getSource().getParent().getBindingContext().getProperty("control_option_level_code")){t.setProperty("/control_option_level_codeEdit",false)}n=e.getSource().getParent().getBindingContext().getProperty("control_option_val");if(e.getSource().getParent().getBindingContext().getProperty("control_option_val")){t.setProperty("/control_option_valEdit",false);e.getSource().getParent().getBindingContext().setProperty("control_option_val",n)}}}console.groupEnd()},_setUIChanges:function(e,t){console.group("_setUIChanges");var o="/hasMainUIChanges";if(e!=null){if(e.getSource().sId.indexOf("control_option_level_code")>-1){o="/hasSubUiChanges"}if(e.getSource().sId.indexOf("control_option_level_val")>-1){o="/hasSubUiChanges"}}else{this.getModel("ui").setProperty("/hasUIChanges",t);this.getModel("ui").setProperty("/hasMainUIChanges",t);this.getModel("ui").setProperty("/hasSubUiChanges",t)}t=this.getView().getModel().hasPendingChanges();console.log("bHasUIChanges",t);var n=this.getModel("ui");n.setProperty(o,t);console.groupEnd()},onSave:function(e){console.group("onSave");var o=e,n="MainUpdateGroup",s=false,i=this,r,a;console.log("tableName: "+o);r=this.byId(o);if(o!="mainList"){s=true;n="SubUpdateGroup";console.log("sub save")}else{console.log("main save")}var l=r.getRows(),c=r.getSelectedIndices(),g=r.getBinding("rows"),u=this.getView().getModel("ui"),i=this;if(!g.hasPendingChanges()){t.error(this.noChangeContent);return}t.confirm(this.confirmSave,{title:this.confirmSaveTitle,initialFocus:sap.m.MessageBox.Action.CANCEL,onClose:function(e){if(e===t.Action.OK){i._submitBatch(n)}else if(e===t.Action.CANCEL){}}});console.groupEnd()},_submitBatch:function(e){console.group("_submitBatch");var o=this.getView();function n(){o.setBusy(false);o.getModel("ui").setProperty("/hasUIChanges",o.getModel().hasPendingChanges())}var s=function(){o.setBusy(false);o.getModel("ui").setProperty("/hasUIChanges",o.getModel().hasPendingChanges());if(e=="SubUpdateGroup"){o.getModel("ui").setProperty("/hasSubUiChanges",false)}else{o.getModel("ui").setProperty("/hasMainUiChanges",false)}this._showMsgStrip("s",this.sucessSave)}.bind(this);var i=function(e){t.error(e.message)}.bind(this);return o.getModel().submitBatch(e).then(s,i);console.groupEnd()},_subListFilter:function(){console.group("subListFilter");var e=this.byId("subList");var t=new i("tenant_id",r.EQ,"0000");var o=e.getBinding("rows");o.filter([t]);console.groupEnd()},_searchControlInit:function(){console.group("_searchControlInit");this._oMultiInput=this.getView().byId("multiInput_office");this._oMultiInput.setTokens(this._getDefaultTokens());this.oColModel=new c(sap.ui.require.toUrl("cm/controlOptionMgr/localService/mockdata")+"/columnsModel.json");this.oOfficeModel=new c(sap.ui.require.toUrl("cm/controlOptionMgr/localService/mockdata")+"/offices.json");this.setModel(this.oOfficeModel,"officeModel");console.groupEnd()},_getDefaultTokens:function(){var e=new d({key:"LG-1400",text:"LG CNS"});return[e]},onValueHelpRequested:function(){console.group("onValueHelpRequested");var e=this.oColModel.getData().cols;this._oValueHelpDialog=sap.ui.xmlfragment("cm.controlOptionMgr.view.ValueHelpDialogOffice",this);this.getView().addDependent(this._oValueHelpDialog);this._oValueHelpDialog.getTableAsync().then(function(t){t.setModel(this.oOfficeModel);t.setModel(this.oColModel,"columns");if(t.bindRows){t.bindAggregation("rows","/OfficeCollection")}if(t.bindItems){t.bindAggregation("items","/OfficeCollection",function(){return new ColumnListItem({cells:e.map(function(e){return new Label({text:"{"+e.template+"}"})})})})}this._oValueHelpDialog.update()}.bind(this));this._oValueHelpDialog.setTokens(this._oMultiInput.getTokens());this._oValueHelpDialog.open();console.groupEnd()},onValueHelpOkPress:function(e){var t=e.getParameter("tokens");this.multiInput_office=this.getView().byId("multiInput_office");this.multiInput_office.setTokens(t);this._oValueHelpDialog.close()},onValueHelpCancelPress:function(){this._oValueHelpDialog.close()},onValueHelpAfterClose:function(){this._oValueHelpDialog.destroy()},_showMsgStrip:function(e,t){console.group("onShowMsgStrip");var o=sap.ui.getCore().byId("msgStrip"),n="Information";switch(e){case"i":n="Information";break;case"w":n="Warning";break;case"e":n="Error";break;case"s":n="Success";break;default:n="Information"}if(o){o.destroy()}this._generateMsgStrip(n,t);console.groupEnd()},_generateMsgStrip:function(e,t){console.group("_generateMsgStrip");var o=this.byId("oVerticalContent"),n=new h("msgStrip",{text:t,showCloseButton:true,showIcon:true,type:e});this.oInvisibleMessage.announce("New Message "+e+" "+t,_.Assertive);o.addContent(n);console.groupEnd()}})});
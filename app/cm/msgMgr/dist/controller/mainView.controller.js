sap.ui.define(["cm/msgMgr/controller/BaseController","sap/base/Log","sap/m/MessageBox","sap/m/MessageToast","sap/ui/core/format/DateFormat","sap/ui/model/Filter","sap/ui/model/FilterOperator","sap/ui/model/FilterType","sap/ui/model/Sorter","sap/ui/model/json/JSONModel","sap/ui/thirdparty/jquery","sap/m/Token","cm/msgMgr/model/formatter"],function(e,t,s,o,i,n,r,a,l,c,u,g,d){"use strict";return e.extend("cm.msgMgr.controller.mainView",{formatter:d,_setMessage:function(){console.group("_setMessage");this.errorHasUIChangesSave="상세 테이블에서 저장하지 않은 변경 내용이 있습니다. [취소] 또는 상세 [저장] 이후 항목 을 선택할수 있습니다.";this.errorIsHasUIChangesCancelSave="저장되지 않은 수정 작업이 모두 취소 됩니다.";this.confirmCancelSave="저장되지 않은 수정 작업이 모두 취소 됩니다.";this.confirmCancelTitle="취소 확인";this.sucessCancel="취소가 성공 하였습니다.";this.errorSubHasUIChangeCreateRow="상세 테이블에서 저장하지 않은 변경 내용이 있습니다. 변경 내용을 저장후 행추가 가능합니다.";this.errorUIChangeCopyRow="상세 테이블에서 저장하지 않은 변경 내용이 있습니다. 변경 내용을 저장후 행복사 가능합니다.";this.errorCheckChangeCopyRow="행복사는 선택 항목이 하나여야 합니다.";this.errorCheckChangeCopyRowTitle="항목 선택 오류";this.errorDeleteRowChooice="삭제할 항목을 선택해야 합니다.";this.confirmAllDeleteRow="선택된 항목을 삭제 하시 겠습니까? 하위 등록된 데이타도 같이 삭제 됩니다.";this.confirmDeleteRow="선택된 항목을 삭제 하시 겠습니까?";this.confirmDeleteRowTitle="삭제 확인";this.sucessDelete="삭제가 성공 하였습니다.";this.sucessSave="저장이 성공 하였습니다.";this.noChangeContent="수정한 내용이 없습니다.";this.confirmSave="저장 하시 겠습니까?";this.confirmSaveTitle="저장 확인";this.sUpdate_user_id="";console.groupEnd()},onInit:function(){console.clear();this._setMessage();this._retrieveParam=new c({mstParam:"",dtlParam:"",lngParam:""});this._createView();this._bTechnicalErrors=false;console.groupEnd()},OnSubmit:function(e){var t=this.getModel("ui"),s=this.getModel("mainModel"),o=this.byId("mainList");var i=o.getBinding("rows"),n=i.getModel("mainModel").oData;this.getView().setBusy(true);i.getContexts()[e.getSource().getParent().getRowBindingContext().iIndex].setProperty("update_user_id","Modified");this.getView().setBusy(false)},_createView:function(){console.group("_createView");var e=this.getView();var t=new c({filterCommonID:"",filterValue:"",hasUIChanges:false,bSearch:false,bNewRow:true,bOldRow:false,bAdd:true,bDelete:false,bCopy:false,bModify:false,bSave:true,bSelect:false,bCheck:false,subListCount:0,bSubCheck:false,bSubListTrue:false,bEvent:""});var s=new c({data:[],selectrow:[]});var o=new c({data:[],selectrow:[]});this.setModel(t,"ui");this.setModel(s,"mainModel");console.groupEnd()},onSearch:function(){var e=this.byId("mainList");var t=[];var i="";var a="";var l=this.getView().byId("search_message_code").getValue();var c=this.getView().byId("search_message_contents").getValue();var u=this.byId("mainList").getBinding("rows");if(u.hasPendingChanges()){s.confirm("수정내용이 있습니다.  먼저 저장하시겠습니까?",{title:"Comfirmation",initialFocus:sap.m.MessageBox.Action.CANCEL,onClose:function(t){if(t===s.Action.OK){g.setBusy(true);g.getModel().submitBatch("MainUpdateGroup").then(d,h);e.clearSelection()}else if(t===s.Action.CANCEL){g.setBusy(false);return}}})}var g=this.getView();var d=function(){g.setBusy(false);o.show("저장 되었습니다.")}.bind(this);var h=function(e){g.setBusy(false);s.error(e.message)}.bind(this);if(this.byId("search_chain_code").getSelectedItem()){i=this.byId("search_chain_code").getSelectedItem().getKey()}if(this.byId("search_language_code").getSelectedItem()){a=this.byId("search_language_code").getSelectedItem().getKey()}if(!this.isValNull(i)){t.push(new n("chain_code",r.Contains,i))}if(!this.isValNull(a)){t.push(new n("language_code",r.Contains,a))}if(!this.isValNull(l)){t.push(new n("message_type_code",r.Contains,l))}if(!this.isValNull(c)){t.push(new n("message_contents",r.Contains,c))}var f=this.byId("mainList").getBinding("rows");this.getView().setBusy(true);f.filter(t);this.getView().setBusy(false)},onCheck:function(e){console.group("onCheck");var t=this.byId("mainList"),s=this.getModel("ui"),o;if(e.getSource().sId.indexOf("mainList")<0){t=this.byId("subList");o=true}else{s.setProperty("/bCheck",true)}var i=t.getBinding("rows"),n,r;if(e.getParameter("rowContext")=="undefined"){return}if(o){console.log("subList row change event");r=e.getParameter("rowContext");n=r.getObject();s.setProperty("/bSubCheck",o)}else{console.log("mainList row change event")}this._setButtonState();console.groupEnd()},_setButtonState:function(){console.group("_setButtonState");var e=this.getModel("ui"),t=this.getView().byId("mainList");var s=t.getSelectedIndices();console.log("table rowindices",s);var o=e.getProperty("/bSubListTrue"),i=e.getProperty("/bSearch");if(i==true){e.setProperty("/bAdd",true);e.setProperty("/bSave",true)}if(e.getProperty("/bCheck")){if(s.length>0){e.setProperty("/bAdd",true);e.setProperty("/bCopy",true);e.setProperty("/bDelete",true);e.setProperty("/bModify",true);if(s.length>1){e.setProperty("/bCopy",false);e.setProperty("/bModify",false)}}else{e.setProperty("/bCopy",false);e.setProperty("/bDelete",false);e.setProperty("/bModify",false)}}else{if(!e.getProperty("/bSubListTrue")){e.setProperty("/bSubCheck",false)}else{s=this.getView().byId("subList").getSelectedIndices().length;console.log("sublist indices length",s);if(s>0){e.setProperty("/bSubCheck",true)}else{e.setProperty("/bSubCheck",false)}}}console.groupEnd()},onCreateRow:function(e){console.group("onCreate");var t="mainList",s=false,o;console.log("tableName: "+t);var i=this.getModel("ui"),n=this.getModel("mainModel"),r=this.byId(t);var a=r.getBinding("rows"),l=a.getModel("mainModel").oData,c=this._getToday(),u=this._getUtcSapDate();o=a.create({tenant_id:"",message_code:"",language_code:"",chain_code:"CM",message_type_code:"",message_contents:"",local_create_dtm:"2020-10-13T00:00:00Z",local_update_dtm:"2020-10-13T00:00:00Z",create_user_id:"Admin",update_user_id:"",system_create_dtm:"2020-10-13T00:00:00Z",system_update_dtm:"2020-10-13T00:00:00Z"});i.setProperty("/bEvent","AddRow");o.created().then(function(){a.refresh()});r.getRows().some(function(e){if(e.getBindingContext()===o){e.focus();e.setSelected(true);return true}});this._setButtonState();console.groupEnd()},onDelete:function(){console.group("onDelete");var e=this.byId("mainList"),t=this.getModel("ui"),o=this;var i=e.getSelectedIndices();if(i.length<1){s.show(this.errorDeleteRowChooice,{icon:s.Icon.ERROR,title:this.errorCheckChangeCopyRowTitle,actions:[s.Action.OK],styleClass:"sapUiSizeCompact"})}else{var n=this.confirmAllDeleteRow;s.confirm(n,{title:this.confirmDeleteRowTitle,initialFocus:sap.m.MessageBox.Action.CANCEL,onClose:function(t){if(t===s.Action.OK){for(var n=i.length;n>=0;n--){var r=i[n];if(e.isIndexSelected(r)){o.getView().setBusy(true);e.getContextByIndex(r).delete("$auto").then(function(){o._showMsgStrip("s",o.sucessDelete);e.clearSelection()}.bind(this),function(e){s.error(e.message)});o.getView().setBusy(false)}}}else if(t===s.Action.CANCEL){return}}})}console.groupEnd()},onCopyRow:function(e){console.group("onCopyRow");var t=this.byId("mainList"),o=t.getBinding("rows"),i=this,n=t.getRows(),r=t.getSelectedIndices(),a=this._getToday(),l=this._getUtcSapDate();var c=this.getModel("ui");console.log("indices",r);if(r.length>1){s.show(this.errorCheckChangeCopyRow,{icon:s.Icon.ERROR,title:this.errorCheckChangeCopyRowTitle,actions:[s.Action.OK],styleClass:"sapUiSizeCompact"});return}var u=this.getModel("mainModel");for(var g=0;g<r.length;g++){var d=r[g];if(t.isIndexSelected(d)){i.getView().setBusy(true);var h=o.create({tenant_id:o.getContexts()[d].getValue("tenant_id"),message_code:o.getContexts()[d].getValue("message_code"),language_code:o.getContexts()[d].getValue("language_code"),chain_code:o.getContexts()[d].getValue("chain_code"),message_type_code:o.getContexts()[d].getValue("message_type_code"),message_contents:o.getContexts()[d].getValue("message_contents"),local_create_dtm:"2020-10-13T00:00:00Z",local_update_dtm:"2020-10-13T00:00:00Z",create_user_id:"Admin",update_user_id:"",system_create_dtm:"2020-10-13T00:00:00Z",system_update_dtm:"2020-10-13T00:00:00Z"});i.getView().setBusy(false)}}c.setProperty("/bEvent","AddRow");this.getView().setBusy(true);t.getRows().some(function(e){if(e.getBindingContext()===h){e.focus();e.setSelected(true);return true}});h.created().then(function(){o.refresh()});this.getView().setBusy(false);console.groupEnd()},onModifyRow:function(e){console.group("onModifyRow");var t=this.byId("mainList"),o=this,i=t.getBinding("rows"),n=t.getRows(),r=this.getModel("ui"),a=t.getSelectedIndices();console.log("indices",a);if(a.length>1){s.show(this.errorCheckChangeCopyRow,{icon:s.Icon.ERROR,title:this.errorCheckChangeCopyRowTitle,actions:[s.Action.OK],styleClass:"sapUiSizeCompact"});return}r.setProperty("/bEvent","ModifyRow");this.getView().setBusy(true);r.setProperty("/bEvent","ModifyRow");for(var l=0;l<a.length;l++){var c=a[l];if(t.isIndexSelected(c)){o.getView().setBusy(true);i.getContexts()[c].setProperty("update_user_id","M");o.getView().setBusy(false)}}this.getView().setBusy(false);console.groupEnd()},OnClick:function(e){},onCellClick(e){console.group("onCellClick");var t=this.byId("mainList"),s=this,o=t.getBinding("rows"),i=t.getRows(),n=this.getModel("ui");if(o.getContexts()[e.getParameter("rowIndex")]===null){return}n.setProperty("/bEvent","ModifyRow");s.getView().setBusy(true);if(o.getContexts()[e.getParameter("rowIndex")].getValue("update_user_id")==="M"){o.getContexts()[e.getParameter("rowIndex")].setProperty("update_user_id","Modify")}else{switch(e.mParameters.columnIndex){case"3":case"4":case"5":this.sUpdate_user_id="Modify";o.getContexts()[e.getParameter("rowIndex")].setProperty("update_user_id","M");default:}}s.getView().setBusy(false);console.groupEnd()},onSave:function(){console.group("onSave");var e=this.byId("mainList");var t=this.byId("mainList").getBinding("rows");if(!t.hasPendingChanges()){s.error("수정한 내용이 없습니다.");return}var i=this.getView();var n=function(){i.setBusy(false);o.show("저장 되었습니다.")}.bind(this);var r=function(e){i.setBusy(false);s.error(e.message)}.bind(this);s.confirm("저장 하시 겠습니까?",{title:"Comfirmation",initialFocus:sap.m.MessageBox.Action.CANCEL,onClose:function(t){if(t===s.Action.OK){i.setBusy(true);i.getModel().submitBatch("MainUpdateGroup").then(n,r);e.clearSelection()}else if(t===s.Action.CANCEL){}}});console.groupEnd()},_submitBatch:function(e){this._submitCheck(e);console.group("_submitBatch");var t=this.getView();function o(){t.setBusy(false);t.getModel("ui").setProperty("/hasUIChanges",t.getModel().hasPendingChanges())}var i=function(){t.setBusy(false);t.getModel("ui").setProperty("/hasUIChanges",t.getModel().hasPendingChanges());if(e=="SubUpdateGroup"){t.getModel("ui").setProperty("/hasSubUiChanges",false)}else{t.getModel("ui").setProperty("/hasMainUiChanges",false)}this._showMsgStrip("s",this.sucessSave)}.bind(this);var n=function(e){this._setBusy(false);s.error(e.message)}.bind(this);return t.getModel().submitBatch(e).then(i,n);console.groupEnd()},_getToday:function(){var e=new Date;var t=("0"+e.getDate()).slice(-2);var s=("0"+(e.getMonth()+1)).slice(-2);var o=e.getFullYear();console.log(o+"-"+s+"-"+t);return o+"-"+s+"-"+t},_getUtcSapDate:function(){var e=sap.ui.core.format.DateFormat.getDateInstance({pattern:"yyyy-MM-dd'T'HH:mm"});var t=new Date;var s=e.format(t)+":00Z";console.log("utcDate",s);return s},isValNull:function(e){if(!e||e==""||e==null){return true}else{return false}}})});
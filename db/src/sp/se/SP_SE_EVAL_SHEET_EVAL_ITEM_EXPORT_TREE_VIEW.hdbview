VIEW SP_SE_EVAL_SHEET_EVAL_ITEM_EXPORT_TREE_VIEW AS
SELECT parent_id
      ,node_id
      ,tenant_id
      ,company_code
      ,org_type_code
      ,org_code
      ,evaluation_operation_unit_code
      ,evaluation_type_code
      ,regular_evaluation_id
      ,evaluation_article_code
      ,evaluation_article_name
      ,parent_evaluation_article_code
      ,evaluation_distrb_score_weight
      ,evaluation_execute_mode_code
      ,evaluation_article_type_code
      ,evaluation_distrb_scr_type_cd
      ,evaluation_result_input_type_cd
      ,qttive_item_uom_code
      ,qttive_eval_article_calc_formula
      ,evaluation_article_desc
      ,evaluation_article_lvl_attr_cd
      ,sort_sequence
      ,evaluation_article_path_sequence
      ,evaluation_article_path_code
      ,evaluation_article_path_name
      ,REPLACE(SUBSTRING(evaluation_article_path_name, 1, INSTR(evaluation_article_path_name, '^', -1)-1),'^','>') higher_level_path_name
      ,REPLACE(evaluation_article_path_name, '^', ' ') AS evaluation_article_display_name
      ,SUBSTR_REGEXPR('[^^]+' IN evaluation_article_path_code FROM 1 OCCURRENCE 1) AS evaluation_article_level1_code
      ,SUBSTR_REGEXPR('[^^]+' IN evaluation_article_path_code FROM 1 OCCURRENCE 2) AS evaluation_article_level2_code
      ,SUBSTR_REGEXPR('[^^]+' IN evaluation_article_path_code FROM 1 OCCURRENCE 3) AS evaluation_article_level3_code
      ,SUBSTR_REGEXPR('[^^]+' IN evaluation_article_path_code FROM 1 OCCURRENCE 4) AS evaluation_article_level4_code
      ,SUBSTR_REGEXPR('[^^]+' IN evaluation_article_path_code FROM 1 OCCURRENCE 5) AS evaluation_article_level5_code
      ,SUBSTR_REGEXPR('[^^]+' IN evaluation_article_path_name FROM 1 OCCURRENCE 1) AS evaluation_article_level1_name
      ,SUBSTR_REGEXPR('[^^]+' IN evaluation_article_path_name FROM 1 OCCURRENCE 2) AS evaluation_article_level2_name
      ,SUBSTR_REGEXPR('[^^]+' IN evaluation_article_path_name FROM 1 OCCURRENCE 3) AS evaluation_article_level3_name
      ,SUBSTR_REGEXPR('[^^]+' IN evaluation_article_path_name FROM 1 OCCURRENCE 4) AS evaluation_article_level4_name
      ,SUBSTR_REGEXPR('[^^]+' IN evaluation_article_path_name FROM 1 OCCURRENCE 5) AS evaluation_article_level5_name
      ,hierarchy_rank            /*현재node의 순번(sibling order by에 의한)*/
      ,hierarchy_tree_size       /*현재node포함 하위node 갯수(1이면 leaf node(마지막node))*/
      ,hierarchy_parent_rank     /*부모node의 순번*/
      ,hierarchy_level - 1 AS hierarchy_level           /*현재node의 Level*/
      ,hierarchy_root_rank       /*root node의 순번*/
      ,hierarchy_is_cycle        /*순환구조여부(0:False, 1:True)*/
      ,hierarchy_is_orphan       /*전개후 연결이 끊어진 노드여부(0:False, 1:True)*/
FROM   HIERARCHY_ANCESTORS_AGGREGATE(
                                     SOURCE sp_se_eval_sheet_eval_item_tree_view
                                     MEASURES (STRING_AGG(evaluation_article_code, '^') AS evaluation_article_path_code,
                                               STRING_AGG(evaluation_article_name, '^') evaluation_article_path_name,
                                     	         STRING_AGG(sort_sequence, '^') evaluation_article_path_sequence,
                                               STRING_AGG(node_id, '/') AS path
                                    )
       ) M
order by evaluation_article_path_name NULLS FIRST
;
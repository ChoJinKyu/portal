VIEW SP_SE_EVAL_SHEET_EVAL_ITEM_OPT_VIEW
AS
SELECT xx.tenant_id
      ,xx.company_code
      ,xx.org_type_code
      ,xx.org_code
      ,xx.evaluation_operation_unit_code
      ,xx.evaluation_type_code
      ,xx.evaluation_article_code
      ,MAX(CASE WHEN xx.opt_rank = 1 THEN CASE WHEN xx.evaluation_result_input_type_cd = 'RANGE' THEN xx.option_article_start_value||'~'||xx.option_article_start_value||'/ Score:'||xx.evaluation_score ELSE 'Score: '||xx.evaluation_score END  ELSE NULL END) scle_display_text1
      ,MAX(CASE WHEN xx.opt_rank = 1 THEN (xx.evaluation_score - IFNULL(xx.lead_score,0)) ELSE null END) opt_range_value1
      ,MAX(CASE WHEN xx.opt_rank = 2 THEN CASE WHEN xx.evaluation_result_input_type_cd = 'RANGE' THEN xx.option_article_start_value||'~'||xx.option_article_start_value||'/ Score:'||xx.evaluation_score ELSE 'Score: '||xx.evaluation_score END  ELSE NULL END) scle_display_text2
      ,MAX(CASE WHEN xx.opt_rank = 2 THEN (xx.evaluation_score - IFNULL(xx.lead_score,0)) ELSE null END) opt_range_value2
      ,MAX(CASE WHEN xx.opt_rank = 3 THEN CASE WHEN xx.evaluation_result_input_type_cd = 'RANGE' THEN xx.option_article_start_value||'~'||xx.option_article_start_value||'/ Score:'||xx.evaluation_score ELSE 'Score: '||xx.evaluation_score END  ELSE NULL END) scle_display_text3
      ,MAX(CASE WHEN xx.opt_rank = 3 THEN (xx.evaluation_score - IFNULL(xx.lead_score,0)) ELSE null END) opt_range_value3
      ,MAX(CASE WHEN xx.opt_rank = 4 THEN CASE WHEN xx.evaluation_result_input_type_cd = 'RANGE' THEN xx.option_article_start_value||'~'||xx.option_article_start_value||'/ Score:'||xx.evaluation_score ELSE 'Score: '||evaluation_score END  ELSE NULL END) scle_display_text4
      ,MAX(CASE WHEN xx.opt_rank = 4 THEN (xx.evaluation_score - IFNULL(xx.lead_score,0)) ELSE null END) opt_range_value4
      ,MAX(CASE WHEN xx.opt_rank = 5 THEN CASE WHEN xx.evaluation_result_input_type_cd = 'RANGE' THEN xx.option_article_start_value||'~'||xx.option_article_start_value||'/ Score:'||xx.evaluation_score ELSE 'Score: '||evaluation_score END  ELSE NULL END) scle_display_text5
      ,MAX(CASE WHEN xx.opt_rank = 5 THEN (xx.evaluation_score - IFNULL(xx.lead_score,0)) ELSE null END) opt_range_value5
      ,MAX(CASE WHEN xx.opt_rank = 6 THEN CASE WHEN xx.evaluation_result_input_type_cd = 'RANGE' THEN xx.option_article_start_value||'~'||xx.option_article_start_value||'/ Score:'||xx.evaluation_score ELSE 'Score: '||evaluation_score END  ELSE NULL END) scle_display_text6
      ,MAX(CASE WHEN xx.opt_rank = 6 THEN (xx.evaluation_score - IFNULL(xx.lead_score,0)) ELSE null END) opt_range_value6
      ,MAX(CASE WHEN xx.opt_rank = 7 THEN CASE WHEN xx.evaluation_result_input_type_cd = 'RANGE' THEN xx.option_article_start_value||'~'||xx.option_article_start_value||'/ Score:'||xx.evaluation_score ELSE 'Score: '||evaluation_score END  ELSE NULL END) scle_display_text7
      ,MAX(CASE WHEN xx.opt_rank = 7 THEN (xx.evaluation_score - IFNULL(xx.lead_score,0)) ELSE null END) opt_range_value7
      ,MAX(CASE WHEN xx.opt_rank = 8 THEN CASE WHEN xx.evaluation_result_input_type_cd = 'RANGE' THEN xx.option_article_start_value||'~'||xx.option_article_start_value||'/ Score:'||xx.evaluation_score ELSE 'Score: '||evaluation_score END  ELSE NULL END) scle_display_text8
      ,MAX(CASE WHEN xx.opt_rank = 8 THEN (xx.evaluation_score - IFNULL(xx.lead_score,0)) ELSE null END) opt_range_value8
      ,MAX(CASE WHEN xx.opt_rank = 9 THEN CASE WHEN xx.evaluation_result_input_type_cd = 'RANGE' THEN xx.option_article_start_value||'~'||xx.option_article_start_value||'/ Score:'||xx.evaluation_score ELSE 'Score: '||evaluation_score END  ELSE NULL END) scle_display_text9
      ,MAX(CASE WHEN xx.opt_rank = 9 THEN (xx.evaluation_score - IFNULL(xx.lead_score,0)) ELSE null END) opt_range_value9
      ,MAX(CASE WHEN xx.opt_rank = 10 THEN CASE WHEN xx.evaluation_result_input_type_cd = 'RANGE' THEN xx.option_article_start_value||'~'||xx.option_article_start_value||'/ Score:'||xx.evaluation_score ELSE 'Score: '||evaluation_score END  ELSE NULL END) scle_display_text10
      ,MAX(CASE WHEN xx.opt_rank = 10 THEN (xx.evaluation_score - IFNULL(xx.lead_score,0)) ELSE null END) opt_range_value10
FROM   (
        SELECT eio.tenant_id
              ,eio.company_code
              ,eio.org_type_code
              ,eio.org_code
              ,eio.evaluation_operation_unit_code
              ,eio.evaluation_type_code
              ,eio.evaluation_article_code
              ,eio.option_article_number
              ,eio.option_article_name
              ,eio.option_article_start_value
              ,eio.option_article_end_value
              ,eio.evaluation_score
              ,eim.evaluation_result_input_type_cd
              ,LEAD(eio.evaluation_score) OVER(PARTITION BY eio.tenant_id
                                       ,eio.company_code
                                       ,eio.org_type_code
                                       ,eio.org_code
                                       ,eio.evaluation_operation_unit_code
                                       ,eio.evaluation_type_code
                                       ,eio.evaluation_article_code 
                            ORDER BY    eio.sort_sequence
              ) AS lead_score
              ,RANK() OVER(PARTITION BY eio.tenant_id
                                       ,eio.company_code
                                       ,eio.org_type_code
                                       ,eio.org_code
                                       ,eio.evaluation_operation_unit_code
                                       ,eio.evaluation_type_code
                                       ,eio.evaluation_article_code 
                            ORDER BY    eio.sort_sequence DESC
              ) AS opt_rank
        FROM   sp_se_eval_item_opt eio
              ,sp_se_eval_item_mst eim
        WHERE  eio.tenant_id                      = eim.tenant_id
        AND    eio.company_code                   = eim.company_code                  
        AND    eio.org_type_code                  = eim.org_type_code                 
        AND    eio.org_code                       = eim.org_code                      
        AND    eio.evaluation_operation_unit_code = eim.evaluation_operation_unit_code
        AND    eio.evaluation_type_code           = eim.evaluation_type_code          
        AND    eio.evaluation_article_code        = eim.evaluation_article_code       
       ) xx
GROUP BY xx.tenant_id
        ,xx.company_code
        ,xx.org_type_code
        ,xx.org_code
        ,xx.evaluation_operation_unit_code
        ,xx.evaluation_type_code
        ,xx.evaluation_article_code;
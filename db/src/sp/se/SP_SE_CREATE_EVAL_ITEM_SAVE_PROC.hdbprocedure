PROCEDURE SP_SE_CREATE_EVAL_ITEM_SAVE_PROC (
    IN I_TENANT_ID     NVARCHAR(5)
   ,IN I_COMPANY_CODE  NVARCHAR(10)
   ,IN I_ORG_TYPE_CODE NVARCHAR(2)
   ,IN I_ORG_CODE      NVARCHAR(10)
   ,IN I_EVALUATION_OPERATION_UNIT_CODE NVARCHAR(30)
   ,IN I_EVALUATION_TYPE_CODE           NVARCHAR(30)
   ,IN I_PARENT_EVALUATION_ARTICLE_CODE NVARCHAR(15)
   ,IN I_EVALUATION_ARTICLE_NAME        NVARCHAR(240)
   ,IN I_EVALUATION_ARTICLE_LVL_ATTR_CD NVARCHAR(30)   
   ,IN I_USER_ID NVARCHAR(255)
   ,OUT O_MSG TABLE(RETURN_CODE NVARCHAR(2),
                    RETURN_MSG NVARCHAR(1000))
)
LANGUAGE SQLSCRIPT
SQL SECURITY INVOKER 
AS
BEGIN
    
    
    /*평가항목 관리 - 평가항목 저장*/
    DECLARE V_SORT_SEQUENCE INT = 0;
    DECLARE V_EVALUATION_ARTICLE_CODE NVARCHAR(15) = '';

    /* SQL Error 처리 */
    DECLARE EXIT HANDLER FOR SQLEXCEPTION ROLLBACK;

    SELECT  IFNULL(I_USER_ID,'SYSTEM') INTO I_USER_ID FROM DUMMY;

    SELECT IFNULL(MAX(EIM.SORT_SEQUENCE),0) + 1 SORT_SEQUENCE
    INTO   V_SORT_SEQUENCE
    FROM   SP_SE_EVAL_ITEM_MST EIM
    WHERE  EIM.TENANT_ID     = :I_TENANT_ID
    AND    EIM.COMPANY_CODE  = :I_COMPANY_CODE
    AND    EIM.ORG_TYPE_CODE = :I_ORG_TYPE_CODE
    AND    EIM.ORG_CODE      = :I_ORG_CODE
    AND    EIM.EVALUATION_OPERATION_UNIT_CODE = :I_EVALUATION_OPERATION_UNIT_CODE
    AND    EIM.EVALUATION_TYPE_CODE           = :I_EVALUATION_TYPE_CODE
    AND    IFNULL(EIM.PARENT_EVALUATION_ARTICLE_CODE,'X') = IFNULL(:I_PARENT_EVALUATION_ARTICLE_CODE,'X')
    ;
    
    /*Get Evaluation Article Code*/
    SELECT 'E'||to_varchar(NOW(), 'yyyymmdd')||LPAD(SP_SE_EVAL_ITEM_ARTICLE_SEQ.NEXTVAL, 4, '0')
    INTO   V_EVALUATION_ARTICLE_CODE
    FROM   DUMMY;
    
    /*Evaluation Item Insert*/
    BEGIN
        DECLARE EXIT HANDLER FOR SQLEXCEPTION
        BEGIN
        
            O_MSG = SELECT  'NG' RETURN_CODE, 'Insert Evaluation Item Processing error. (' || ::SQL_ERROR_CODE || '-' || ::SQL_ERROR_MESSAGE  || ')' RETURN_MSG FROM  DUMMY;
            RESIGNAL;
        END;

        INSERT INTO SP_SE_EVAL_ITEM_MST
        (TENANT_ID
        ,COMPANY_CODE
        ,ORG_TYPE_CODE
        ,ORG_CODE
        ,EVALUATION_OPERATION_UNIT_CODE
        ,EVALUATION_TYPE_CODE
        ,EVALUATION_ARTICLE_CODE
        ,EVALUATION_ARTICLE_NAME
        ,PARENT_EVALUATION_ARTICLE_CODE
        ,EVALUATION_ARTICLE_LVL_ATTR_CD
        ,SORT_SEQUENCE
        ,LOCAL_CREATE_DTM
        ,LOCAL_UPDATE_DTM
        ,CREATE_USER_ID
        ,UPDATE_USER_ID
        ,SYSTEM_CREATE_DTM
        ,SYSTEM_UPDATE_DTM
        )
        VALUES
        (:I_TENANT_ID
        ,:I_COMPANY_CODE
        ,:I_ORG_TYPE_CODE
        ,:I_ORG_CODE
        ,:I_EVALUATION_OPERATION_UNIT_CODE
        ,:I_EVALUATION_TYPE_CODE
        ,:V_EVALUATION_ARTICLE_CODE
        ,:I_EVALUATION_ARTICLE_NAME
        ,:I_PARENT_EVALUATION_ARTICLE_CODE
        ,:I_EVALUATION_ARTICLE_LVL_ATTR_CD
        ,:V_SORT_SEQUENCE
        ,NOW()
        ,NOW()
        ,:I_USER_ID
        ,:I_USER_ID
        ,NOW()
        ,NOW()
        );
    END;
    
    COMMIT;
    O_MSG = SELECT 'OK' RETURN_CODE, 'Successfully Saved.' RETURN_MSG FROM DUMMY;
END;
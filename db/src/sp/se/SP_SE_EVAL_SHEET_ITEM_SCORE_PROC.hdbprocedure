PROCEDURE SP_SE_EVAL_SHEET_ITEM_SCORE_PROC (
    IN I_ITEM_TYPE TABLE(TENANT_ID     NVARCHAR(5)                       /*테넌트ID*/
                        ,COMPANY_CODE  NVARCHAR(10)                      /*회사코드*/
                        ,ORG_TYPE_CODE NVARCHAR(2)                       /*조직유형코드*/
                        ,ORG_CODE      NVARCHAR(10)                      /*조직코드*/
                        ,EVALUATION_OPERATION_UNIT_CODE   NVARCHAR(30)   /*평가운영단위코드*/
                        ,EVALUATION_TYPE_CODE             NVARCHAR(30)   /*평가유형코드*/
                        ,EVALUATION_ARTICLE_CODE          NVARCHAR(15)   /*평가항목코드*/                        
                        ,EVALUATION_DISTRB_SCORE_WEIGHT   DECIMAL        /*가중치*/
                        ,EVALUATION_ARTICLE_LEVEL1_CODE   NVARCHAR(15)   /*최상위평가항목코드*/
                        ,REGULAR_EVALUATION_ID            NVARCHAR(100)  /*정기평가ID*/
                        )
   ,IN I_USER_ID NVARCHAR(255)
   ,OUT O_MSG TABLE(RETURN_CODE NVARCHAR(2),
                    RETURN_MSG NVARCHAR(1000))
)
LANGUAGE SQLSCRIPT
SQL SECURITY INVOKER
AS
BEGIN
    /*평가Sheet관리 - 평가항목복사*/
    DECLARE V_TOP_ARTICLE_CODE NVARCHAR(15);
    
    DECLARE V_TENANT_ID     NVARCHAR(5);                       /*테넌트ID*/
    DECLARE V_COMPANY_CODE  NVARCHAR(10);                      /*회사코드*/
    DECLARE V_ORG_TYPE_CODE NVARCHAR(2);                       /*조직유형코드*/
    DECLARE V_ORG_CODE      NVARCHAR(10);                      /*조직코드*/
    DECLARE V_EVALUATION_OPERATION_UNIT_CODE   NVARCHAR(30);   /*평가운영단위코드*/
    DECLARE V_EVALUATION_TYPE_CODE             NVARCHAR(30);   /*평가유형코드*/
    DECLARE V_REGULAR_EVALUATION_ID            NVARCHAR(100);  /*정기평가ID*/
    
    
    
    DECLARE VT_ITEM_TYPE TABLE(TENANT_ID     NVARCHAR(5)                       /*테넌트ID*/
                              ,COMPANY_CODE  NVARCHAR(10)                      /*회사코드*/
                              ,ORG_TYPE_CODE NVARCHAR(2)                       /*조직유형코드*/
                              ,ORG_CODE      NVARCHAR(10)                      /*조직코드*/
                              ,EVALUATION_OPERATION_UNIT_CODE   NVARCHAR(30)   /*평가운영단위코드*/
                              ,EVALUATION_TYPE_CODE             NVARCHAR(30)   /*평가유형코드*/
                              ,EVALUATION_ARTICLE_CODE          NVARCHAR(15)   /*평가항목코드*/                        
                              ,EVALUATION_DISTRB_SCORE          DECIMAL        /*가중치*/
                              ,REGULAR_EVALUATION_ID            NVARCHAR(100)  /*정기평가ID*/
                              );
    DECLARE NOT_INSERT_CNT CONDITION FOR SQL_ERROR_CODE 10000;
    DECLARE EXIT HANDLER FOR SQLEXCEPTION ROLLBACK;
    

    SELECT  IFNULL(:I_USER_ID, 'SYSTEM') INTO I_USER_ID FROM DUMMY;

    /* SQL Error 처리 */
    BEGIN
        DECLARE EXIT HANDLER FOR SQLEXCEPTION
        :O_MSG.INSERT(('NG','Score Evaluation Sheet error. (' || ::SQL_ERROR_CODE || '-' || ::SQL_ERROR_MESSAGE  || ')'),1);
    END;
    
    V_TOP_ARTICLE_CODE                   = :I_ITEM_TYPE.EVALUATION_ARTICLE_LEVEL1_CODE[1];
    V_TENANT_ID                          = :I_ITEM_TYPE.TENANT_ID[1];                     
    V_COMPANY_CODE                       = :I_ITEM_TYPE.COMPANY_CODE[1];                 
    V_ORG_TYPE_CODE                      = :I_ITEM_TYPE.ORG_TYPE_CODE[1];                 
    V_ORG_CODE                           = :I_ITEM_TYPE.ORG_CODE[1];                      
    V_EVALUATION_OPERATION_UNIT_CODE     = :I_ITEM_TYPE.EVALUATION_OPERATION_UNIT_CODE[1];
    V_EVALUATION_TYPE_CODE               = :I_ITEM_TYPE.EVALUATION_TYPE_CODE[1];
    V_REGULAR_EVALUATION_ID              = :I_ITEM_TYPE.REGULAR_EVALUATION_ID[1];
    
    /*평가항목 입력.*/    
    MERGE INTO SP_SE_EVAL_SHEET_EVAL_ITEM ESEI
    USING :I_ITEM_TYPE ITEM
    ON ( ESEI.TENANT_ID                            = ITEM.TENANT_ID
         AND   ESEI.COMPANY_CODE                   = ITEM.COMPANY_CODE
         AND   ESEI.ORG_TYPE_CODE                  = ITEM.ORG_TYPE_CODE
         AND   ESEI.ORG_CODE                       = ITEM.ORG_CODE
         AND   ESEI.EVALUATION_OPERATION_UNIT_CODE = ITEM.EVALUATION_OPERATION_UNIT_CODE
         AND   ESEI.EVALUATION_TYPE_CODE           = ITEM.EVALUATION_TYPE_CODE
         AND   ESEI.REGULAR_EVALUATION_ID          = ITEM.REGULAR_EVALUATION_ID
         AND   ESEI.EVALUATION_ARTICLE_CODE        = ITEM.EVALUATION_ARTICLE_CODE
       )
    WHEN MATCHED THEN
        UPDATE
        SET    ESEI.EVALUATION_DISTRB_SCORE_WEIGHT = ITEM.EVALUATION_DISTRB_SCORE_WEIGHT
              ,ESEI.LOCAL_UPDATE_DTM                  = NOW()
              ,ESEI.UPDATE_USER_ID                    = :I_USER_ID
              ,ESEI.SYSTEM_UPDATE_DTM                 = NOW()
    ;
    
    /*상위항목 가중치 변경*/
    VT_ITEM_TYPE = SELECT A.TENANT_ID
                         ,A.COMPANY_CODE
                         ,A.ORG_TYPE_CODE
                         ,A.ORG_CODE
                         ,A.EVALUATION_OPERATION_UNIT_CODE
                         ,A.EVALUATION_TYPE_CODE
                         ,A.EVALUATION_ARTICLE_CODE
                         ,A.EVALUATION_DISTRB_SCORE
                         ,A.REGULAR_EVALUATION_ID
                   FROM   (
                           SELECT TENANT_ID
                                 ,COMPANY_CODE 
                                 ,ORG_TYPE_CODE
                                 ,ORG_CODE
                                 ,EVALUATION_OPERATION_UNIT_CODE
                                 ,EVALUATION_TYPE_CODE
                                 ,REGULAR_EVALUATION_ID
                                 ,EVALUATION_ARTICLE_CODE
                                 ,EVALUATION_ARTICLE_NAME
                                 ,PARENT_EVALUATION_ARTICLE_CODE  
                                 ,EVALUATION_DISTRB_SCORE
                                 ,HIERARCHY_RANK
                                 ,HIERARCHY_TREE_SIZE
                                 ,HIERARCHY_PARENT_RANK
                                 ,HIERARCHY_LEVEL
                                 ,HIERARCHY_ROOT_RANK
                                 ,HIERARCHY_IS_CYCLE
                                 ,HIERARCHY_IS_ORPHAN
                           FROM  HIERARCHY_DESCENDANTS_AGGREGATE(
                                                                 SOURCE SP_SE_EVAL_SHEET_EVAL_ITEM_TREE_VIEW
                                                                 MEASURES (SUM(EVALUATION_DISTRB_SCORE_WEIGHT) AS EVALUATION_DISTRB_SCORE
                                                                ) 
                                  )
                                  
                          ) A
                   WHERE EXISTS (SELECT 1 
                                 FROM  SP_SE_EVAL_SHEET_EVAL_ITEM_EXPORT_TREE_VIEW B 
                                 WHERE B.TENANT_ID      = A.TENANT_ID
                                 AND   B.COMPANY_CODE   = A.COMPANY_CODE
                                 AND   B.ORG_TYPE_CODE  = A.ORG_TYPE_CODE
                                 AND   B.ORG_CODE       = A.ORG_CODE
                                 AND   B.EVALUATION_OPERATION_UNIT_CODE = A.EVALUATION_OPERATION_UNIT_CODE
                                 AND   B.EVALUATION_TYPE_CODE    = A.EVALUATION_TYPE_CODE
                                 AND   B.EVALUATION_ARTICLE_CODE = A.EVALUATION_ARTICLE_CODE
                                 AND   B.REGULAR_EVALUATION_ID   = A.REGULAR_EVALUATION_ID
                                 AND   B.TENANT_ID      = :V_TENANT_ID
                                 AND   B.COMPANY_CODE   = :V_COMPANY_CODE
                                 AND   B.ORG_TYPE_CODE  = :V_ORG_TYPE_CODE
                                 AND   B.ORG_CODE       = :V_ORG_CODE
                                 AND   B.EVALUATION_OPERATION_UNIT_CODE = :V_EVALUATION_OPERATION_UNIT_CODE
                                 AND   B.EVALUATION_TYPE_CODE    = :V_EVALUATION_TYPE_CODE
                                 AND   B.REGULAR_EVALUATION_ID   = :V_REGULAR_EVALUATION_ID
                   	             AND   INSTR(B.EVALUATION_ARTICLE_PATH_CODE, :V_TOP_ARTICLE_CODE) > 0
                                )
                   
                   ;
    
    
    /*평가항목 입력.*/    
    MERGE INTO SP_SE_EVAL_SHEET_EVAL_ITEM ESEI
    USING :VT_ITEM_TYPE ITEM
    ON (       ESEI.TENANT_ID                      = ITEM.TENANT_ID
         AND   ESEI.COMPANY_CODE                   = ITEM.COMPANY_CODE
         AND   ESEI.ORG_TYPE_CODE                  = ITEM.ORG_TYPE_CODE
         AND   ESEI.ORG_CODE                       = ITEM.ORG_CODE
         AND   ESEI.EVALUATION_OPERATION_UNIT_CODE = ITEM.EVALUATION_OPERATION_UNIT_CODE
         AND   ESEI.EVALUATION_TYPE_CODE           = ITEM.EVALUATION_TYPE_CODE
         AND   ESEI.REGULAR_EVALUATION_ID          = ITEM.REGULAR_EVALUATION_ID
         AND   ESEI.EVALUATION_ARTICLE_CODE        = ITEM.EVALUATION_ARTICLE_CODE
       )
    WHEN MATCHED THEN
        UPDATE
        SET    ESEI.EVALUATION_DISTRB_SCORE_WEIGHT = ITEM.EVALUATION_DISTRB_SCORE
              ,ESEI.LOCAL_UPDATE_DTM               = NOW()
              ,ESEI.UPDATE_USER_ID                 = :I_USER_ID
              ,ESEI.SYSTEM_UPDATE_DTM              = NOW()
    ;

    COMMIT;

    :O_MSG.INSERT(('OK','Successfully Saved.==>'||RECORD_COUNT(:I_ITEM_TYPE)),1);
END
PROCEDURE SP_SE_CREATE_REGULAR_EVAL_SUM_PROC (
    IN I_TENANT_ID     NVARCHAR(5)                      /*테넌트ID*/
   ,IN I_COMPANY_CODE  NVARCHAR(10)                     /*회사코드*/
   ,IN I_ORG_TYPE_CODE NVARCHAR(2)                      /*조직유형코드*/
   ,IN I_ORG_CODE      NVARCHAR(10)                     /*조직코드*/
   ,IN I_EVALUATION_OPERATION_UNIT_CODE  NVARCHAR(30)   /*평가운영단위코드*/
   ,IN I_EVALUATION_TYPE_CODE            NVARCHAR(30)   /*평가유형코드*/
   ,IN I_REGULAR_EVALUATION_YEAR         NVARCHAR(4)    /*정기평가년도*/
   ,IN I_REGULAR_EVALUATION_PERIOD_CODE  NVARCHAR(30)   /*정기평가기간코드*/
   ,IN I_REGULAR_EVALUATION_NAME         NVARCHAR(240)  /*정기평가명*/
   ,IN I_ACTUAL_AGGREGATE_START_DATE     NVARCHAR(8)    /*실적집계시작일자*/
   ,IN I_ACTUAL_AGGREGATE_END_DATE       NVARCHAR(8)    /*실적집계종료일자*/
   ,IN I_REGULAR_EVALUATION_EXEC_STR_DT  NVARCHAR(8)    /*정기평가실행시작일자*/
   ,IN I_REGULAR_EVALUATION_EXEC_END_DT  NVARCHAR(8)    /*정기평가실행종료일자*/
   ,IN I_USER_ID NVARCHAR(255)
   ,OUT O_MSG TABLE(RETURN_CODE NVARCHAR(2),
                    RETURN_MSG NVARCHAR(1000))
)
LANGUAGE SQLSCRIPT
SQL SECURITY INVOKER 
AS
BEGIN
    
    
    /*평가항목 관리 - 평가항목 저장*/
    DECLARE V_REGULAR_EVALUATION_ID NVARCHAR(100);
    DECLARE V_REGULAR_EVAL_PROG_STATUS_CD NVARCHAR(30) = '10'; /*정기평가진행상태코드*/
    
    /* SQL Error 처리 */
    DECLARE EXIT HANDLER FOR SQLEXCEPTION ROLLBACK;

    SELECT  IFNULL(I_USER_ID,'SYSTEM') INTO I_USER_ID FROM DUMMY;

    /*정기평가ID 형식: 2021_0000001*/
    SELECT :I_REGULAR_EVALUATION_YEAR||'_'||LPAD(IFNULL(MAX(TO_NUMBER(SUBSTR(RES.REGULAR_EVALUATION_ID,6))),0) + 1,7,'0')
    INTO   V_REGULAR_EVALUATION_ID
    FROM   SP_SE_REGULAR_EVAL_SUM RES
    WHERE  1=1
    AND    INSTR(RES.REGULAR_EVALUATION_ID, :I_REGULAR_EVALUATION_YEAR) > 0
    ;
    /*Evaluation Item Insert*/
    BEGIN
        DECLARE EXIT HANDLER FOR SQLEXCEPTION
        BEGIN
        
            :O_MSG.INSERT(('NG','Create Evaluation Sheet error. (' || ::SQL_ERROR_CODE || '-' || ::SQL_ERROR_MESSAGE  || ')'),1);
            RESIGNAL;
        END;

        INSERT INTO SP_SE_REGULAR_EVAL_SUM
        (TENANT_ID                      /*테넌트ID*/	
        ,COMPANY_CODE                   /*회사코드*/
        ,ORG_TYPE_CODE                  /*조직유형코드*/
        ,ORG_CODE                       /*조직코드*/
        ,EVALUATION_OPERATION_UNIT_CODE /*평가운영단위코드*/
        ,EVALUATION_TYPE_CODE           /*평가유형코드*/
        ,REGULAR_EVALUATION_ID          /*정기평가ID*/
        ,REGULAR_EVALUATION_YEAR        /*정기평가년도*/
        ,REGULAR_EVALUATION_PERIOD_CODE /*정기평가기간코드*/
        ,REGULAR_EVALUATION_NAME        /*정기평가명*/
        ,REGULAR_EVAL_PROG_STATUS_CD    /*정기평가진행상태코드*/
        ,ACTUAL_AGGREGATE_START_DATE    /*실적집계시작일자*/
        ,ACTUAL_AGGREGATE_END_DATE      /*실적집계종료일자*/
        ,REGULAR_EVALUATION_EXEC_STR_DT /*정기평가실행시작일자*/
        ,REGULAR_EVALUATION_EXEC_END_DT /*정기평가실행종료일자*/
        ,LOCAL_CREATE_DTM
        ,LOCAL_UPDATE_DTM
        ,CREATE_USER_ID
        ,UPDATE_USER_ID
        ,SYSTEM_CREATE_DTM
        ,SYSTEM_UPDATE_DTM
        )
        VALUES
        (:I_TENANT_ID                      /*테넌트ID*/	
        ,:I_COMPANY_CODE                   /*회사코드*/
        ,:I_ORG_TYPE_CODE                  /*조직유형코드*/
        ,:I_ORG_CODE                       /*조직코드*/
        ,:I_EVALUATION_OPERATION_UNIT_CODE /*평가운영단위코드*/
        ,:I_EVALUATION_TYPE_CODE           /*평가유형코드*/
        ,V_REGULAR_EVALUATION_ID           /*정기평가ID*/
        ,:I_REGULAR_EVALUATION_YEAR        /*정기평가년도*/
        ,:I_REGULAR_EVALUATION_PERIOD_CODE /*정기평가기간코드*/
        ,:I_REGULAR_EVALUATION_NAME        /*정기평가명*/
        ,V_REGULAR_EVAL_PROG_STATUS_CD     /*정기평가진행상태코드(SP_SE_EVAL_PROGRESS_STATUS_CD)*/
        ,:I_ACTUAL_AGGREGATE_START_DATE    /*실적집계시작일자*/
        ,:I_ACTUAL_AGGREGATE_END_DATE      /*실적집계종료일자*/
        ,:I_REGULAR_EVALUATION_EXEC_STR_DT /*정기평가실행시작일자*/
        ,:I_REGULAR_EVALUATION_EXEC_END_DT /*정기평가실행종료일자*/
        ,NOW()
        ,NOW()
        ,:I_USER_ID
        ,:I_USER_ID
        ,NOW()
        ,NOW()
        );
    END;
    
    COMMIT;
    :O_MSG.INSERT(('OK', 'Successfully Saved.'),1);
    
END